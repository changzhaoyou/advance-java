# 分布式事务方案

 分布式事务

**一、两阶段提交方案/XA方案**<br/>

        所谓的 XA 方案，即：两阶段提交，有一个事务管理器的概念，负责协调多个数据库（资源管理器）的事务，事务管理器先问问各个数据库你准备好了吗？如果每个数据库都回复 ok，那么就正式提交事务，在各个数据库上执行操作；如果任何其中一个数据库回答不 ok，那么就回滚事务。
        这种分布式事务方案，比较适合单块应用里，跨多个库的分布式事务，而且因为严重依赖于数据库层面来搞定复杂的事务，效率很低，绝对不适合高并发的场景。如果要玩儿，那么基于 Spring + JTA+Atomikos事务管理器 就可以搞定，自己随便搜个 demo 看看就知道了。
        这个方案，我们很少用，一般来说某个系统内部如果出现跨多个库的这么一个操作，是不合规的。我可以给大家介绍一下， 现在微服务，一个大的系统分成几十个甚至几百个服务。一般来说，我们的规定和规范，是要求每个服务只能操作自己对应的一个数据库。
      如果你要操作别的服务对应的库，不允许直连别的服务的库，违反微服务架构的规范，你随便交叉胡乱访问，几百个服务的话，全体乱套，这样的一套服务是没法管理的，没法治理的，可能会出现数据被别人改错，自己的库被别人写挂等情况。如果你要操作别人的服务的库，你必须是通过调用别的服务的接口来实现，绝对不允许交叉访问别人的数据库。
![image_1dfvlpjs3qg6m1nl9q1mcu4u49.png-85.7kB][1]<br/>
**二、TCC方案**<br/>
    TCC全称：Try、Confirm、Cancel.<br/>
     - Try阶段：这个阶段对资源进行锁定或者预留。<br/>
     - Confirm阶段：确定阶段，对资源执行确认操作。<br/>
     - Cancel阶段：异常或者执行失败，进行回滚，也就是进行补偿。<br/>
     一般资金交易有关的采用的一种方式，但是编码复杂，比较难维护。<br/>
     ![image_1dg1da45nftr1nnj15iv6km16ej23.png-70.4kB][2]<br/>
**三、本地消息表**<br/>
     ebay系统早期采用这种方式处理，分布式事务。<br/>
     1、首先，系统A服务执行本地事务，分别插入业务数据和消息数据，成功之后进行发消息，消息发送成功，修改本地消息表的状态，已发送。<br/>
     2、系统B收到消息后，先插入业务和消息表，如果执行成功后，通知A系统接口，事务执行成功或者失败。当然这里采用接口通知，也可以采用zookeeper形式，实时通知系统A修改消息表的状态。<br/>
     3、如果发MQ消息失败的情况或者B系统执行失败的情况，需要后台线程或者定时任务检查消息表的数据。<br/>
![本地消息][3]
**四、最终一致性方案**<br/>
      1. 系统A先把消息发送到prepare消息到MQ，如果发送成功后，执行本地事务。<br/>
      2. 如果本地事务执行成功，发送confirm消息到MQ，如果本地执行失败，取消确认消息。<br/>
      3. RocketMQ会轮询prepare消息，确实是否发送出去，还是回滚。<br/>
      4. 确认消息后，系统B会接收到消息后，执行本地事务，如果失败，一直重试，如果重试次数超过一定阈值，存到数据库中，进行手动补偿机制。<br/>
![image_1dg1qr625142kftliv8pd51nu73d.png-48.4kB][4]<br/>
**五、最大努力通知型**<br/>
     1、和最终一致性方案大致相同，只是消息端，先进入消息服务端，记录消息。<br/>
     2、消息服务调用实际操作系统B服务，执行操作业务。<br/>
     3、消费服务调用系统B服务失败，可以持久化消息，定时任务重试接口，设置重试阈值。<br/>
![image_1dg1thgk4egu15js1pti1aigjgu3q.png-44.6kB][5]<br/>

  [1]: http://static.zybuluo.com/yzz19881016/awx74ca8ach8pfpg555igrhw/image_1dfvlpjs3qg6m1nl9q1mcu4u49.png
  [2]: http://static.zybuluo.com/yzz19881016/y7v0y7jwffa3lpzv3fn0w23e/image_1dg1da45nftr1nnj15iv6km16ej23.png
  [3]: http://static.zybuluo.com/yzz19881016/qc8vupcabza1kclnykhpmsnt/image_1dg1em42gm6dvvb15ul1p951fdb30.png
  [4]: http://static.zybuluo.com/yzz19881016/84216kbpf4jf7apinummb00j/image_1dg1qr625142kftliv8pd51nu73d.png
  [5]: http://static.zybuluo.com/yzz19881016/x0go6t45ff9z4iwu3phh70vp/image_1dg1thgk4egu15js1pti1aigjgu3q.png